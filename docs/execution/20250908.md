# 📁 Python 파일 구조화 실행 계획

## 🎯 1단계 목표 (현재 Python 파일만 처리)
- 기존 Python 코드를 역할별로 분리
- 인터페이스 기반 설계 준비
- 향후 확장을 위한 빈 파일 구조 생성
- 기존 기능 유지하면서 점진적 리팩토링

## 📂 새로운 폴더 구조

```
D:\stocktrading\0908.claude-init\
├── main.py                     # 새로 생성: 애플리케이션 진입점
├── config.yaml                 # 기존 유지
├── requirements.txt            # 기존 유지
├── claude.md                   # 기존 유지
├── kismain.ui                  # 기존 유지
├── 
├── core/                       # 새 폴더: 핵심 비즈니스 로직
│   ├── __init__.py            # 새로 생성
│   ├── interfaces/            # 새 폴더: 추상 인터페이스
│   │   ├── __init__.py        # 새로 생성
│   │   ├── broker_interface.py # 새로 생성: 증권사 인터페이스 정의
│   │   └── strategy_interface.py # 새로 생성: 전략 인터페이스 정의
│   ├── trading_engine.py      # 새로 생성: RSI/MACD 로직 이동
│   └── order_processor.py     # 새로 생성: send_tr_process 함수 이동
├── 
├── brokers/                   # 새 폴더: 증권사별 구현
│   ├── __init__.py           # 새로 생성
│   ├── korea_investment/     # 새 폴더: 한국투자증권
│   │   ├── __init__.py       # 새로 생성
│   │   ├── ki_api.py         # 새로 생성: utils.py의 KoreaInvestAPI 이동
│   │   ├── ki_env.py         # 새로 생성: utils.py의 KoreaInvestEnv 이동
│   │   └── token_manager.py  # 새로 생성: utils.py의 TokenManager 이동
│   ├── ls_securities/        # 새 폴더: LS증권 (빈 파일들)
│   │   ├── __init__.py       # 새로 생성: 빈 파일
│   │   ├── ls_api.py         # 새로 생성: 빈 파일, TODO 주석만
│   │   └── ls_env.py         # 새로 생성: 빈 파일, TODO 주석만
│   └── factory.py            # 새로 생성: 브로커 선택 로직
├── 
├── ui/                       # 새 폴더: UI 컴포넌트
│   ├── __init__.py          # 새로 생성
│   ├── qt/                  # 새 폴더: PyQt5 관련
│   │   ├── __init__.py      # 새로 생성
│   │   ├── main_window.py   # 새로 생성: rsimacd_trading.py의 KISAPIForm 이동
│   │   └── pandas_model.py  # 새로 생성: rsimacd_trading.py의 PandasModel 이동
│   ├── web/                 # 새 폴더: 웹 UI (빈 파일들)
│   │   ├── __init__.py      # 새로 생성: 빈 파일
│   │   └── api_client.py    # 새로 생성: 빈 파일, TODO 주석
│   └── mobile/              # 새 폴더: 모바일 UI (빈 파일들)
│       ├── __init__.py      # 새로 생성: 빈 파일
│       └── api_client.py    # 새로 생성: 빈 파일, TODO 주석
├── 
├── services/                # 새 폴더: 서비스 계층 (빈 파일들)
│   ├── __init__.py         # 새로 생성
│   ├── account_service.py  # 새로 생성: 빈 파일, TODO 주석
│   ├── trading_service.py  # 새로 생성: 빈 파일, TODO 주석
│   └── market_service.py   # 새로 생성: 빈 파일, TODO 주석
├── 
├── utils/                   # 새 폴더: 공통 유틸리티
│   ├── __init__.py         # 새로 생성
│   ├── logger.py           # 새로 생성: 로깅 설정
│   └── helpers.py          # 새로 생성: 헬퍼 함수들
├── 
├── data/                   # 새 폴더: 데이터 파일
│   └── realtime_watchlist_df.pkl # 기존 파일 이동
├── 
├── tests/                  # 새 폴더: 테스트 (빈 파일들)
│   ├── __init__.py        # 새로 생성: 빈 파일
│   ├── test_trading.py    # 새로 생성: 빈 파일, TODO 주석
│   └── test_brokers.py    # 새로 생성: 빈 파일, TODO 주석
├── 
└── legacy/                # 새 폴더: 기존 파일 백업
    ├── rsimacd_trading.py # 기존 파일 백업
    ├── utils.py           # 기존 파일 백업
    └── kis_stock.py       # 기존 파일 백업
```

## 🔄 상세 실행 단계

### Step 1: 폴더 구조 생성
```bash
# 새 폴더 생성
mkdir core core/interfaces brokers brokers/korea_investment brokers/ls_securities
mkdir ui ui/qt ui/web ui/mobile services utils data tests legacy

# __init__.py 파일 생성
touch core/__init__.py core/interfaces/__init__.py
touch brokers/__init__.py brokers/korea_investment/__init__.py brokers/ls_securities/__init__.py
touch ui/__init__.py ui/qt/__init__.py ui/web/__init__.py ui/mobile/__init__.py
touch services/__init__.py utils/__init__.py tests/__init__.py
```

### Step 2: 기존 파일 백업
- `rsimacd_trading.py` → `legacy/rsimacd_trading.py`
- `utils.py` → `legacy/utils.py`
- `kis_stock.py` → `legacy/kis_stock.py`

### Step 3: 인터페이스 파일 생성 (빈 파일)

#### `core/interfaces/broker_interface.py`
```python
# TODO: 증권사 API 추상 인터페이스 정의
# - authenticate()
# - get_account_balance()  
# - place_order()
# - cancel_order()
# - get_stock_price()

from abc import ABC, abstractmethod

class BrokerInterface(ABC):
    pass  # 향후 구현 예정
```

#### `core/interfaces/strategy_interface.py`
```python
# TODO: 트레이딩 전략 추상 인터페이스 정의
# - analyze()
# - get_buy_conditions()
# - get_sell_conditions()

from abc import ABC, abstractmethod

class StrategyInterface(ABC):
    pass  # 향후 구현 예정
```

### Step 4: 핵심 로직 파일 분리

#### `core/trading_engine.py`
```python
# rsimacd_trading.py에서 이동할 내용:
# - RSI/MACD 계산 로직 (line 71-82)
# - 매수/매도 조건 판단 로직 (line 383-451)
# - 수익률 계산 로직 (line 371-378, 427-434)

import pandas as pd
import talib as ta
from loguru import logger

class TradingEngine:
    def __init__(self):
        pass
    
    def calculate_indicators(self, df):
        # RSI/MACD 계산 로직 이동
        pass
    
    def check_buy_signal(self, 현MACD, 현MACD_signal, 전MACD, 전MACD_signal, 현RSI, 전RSI, buy_conditions):
        # 매수 시그널 체크 로직 이동
        pass
    
    def check_sell_signal(self, 현MACD, 현MACD_signal, 전MACD, 전MACD_signal, 현RSI, 전RSI, sell_conditions):
        # 매도 시그널 체크 로직 이동  
        pass
```

#### `core/order_processor.py`
```python
# rsimacd_trading.py에서 이동할 내용:
# - send_tr_process() 함수 전체 (line 25-111)

from multiprocessing import Queue
from loguru import logger

def send_tr_process(korea_invest_api, tr_req_queue: Queue, tr_result_queue: Queue):
    # 기존 send_tr_process 함수 내용 이동
    pass
```

### Step 5: API 클래스 분리

#### `brokers/korea_investment/ki_api.py`
```python
# utils.py에서 이동할 내용:
# - KoreaInvestAPI 클래스 전체 (line 421-1024)

class KoreaInvestAPI:
    # utils.py의 KoreaInvestAPI 클래스 내용 이동
    pass
```

#### `brokers/korea_investment/ki_env.py`
```python
# utils.py에서 이동할 내용:
# - KoreaInvestEnv 클래스 (line 128-420)

class KoreaInvestEnv:
    # utils.py의 KoreaInvestEnv 클래스 내용 이동
    pass
```

#### `brokers/korea_investment/token_manager.py`
```python
# utils.py에서 이동할 내용:
# - TokenManager 클래스 (line 32-127)

class TokenManager:
    # utils.py의 TokenManager 클래스 내용 이동
    pass
```

### Step 6: UI 클래스 분리

#### `ui/qt/main_window.py`
```python
# rsimacd_trading.py에서 이동할 내용:
# - KISAPIForm 클래스 전체 (line 198-569)

from PyQt5.QtWidgets import QMainWindow
from PyQt5 import uic

form_class = uic.loadUiType("kismain.ui")[0]

class KISAPIForm(QMainWindow, form_class):
    # 기존 KISAPIForm 클래스 내용 이동
    pass
```

#### `ui/qt/pandas_model.py`
```python
# rsimacd_trading.py에서 이동할 내용:
# - PandasModel 클래스 (line 116-187)

from PyQt5.QtCore import QAbstractTableModel

class PandasModel(QAbstractTableModel):
    # 기존 PandasModel 클래스 내용 이동
    pass
```

### Step 7: 새로운 main.py 생성
```python
# 애플리케이션 진입점
# rsimacd_trading.py의 main 실행 부분 (line 573-609) 이동 및 수정

import sys
from PyQt5.QtWidgets import QApplication
from ui.qt.main_window import KISAPIForm
from brokers.korea_investment.ki_api import KoreaInvestAPI
from brokers.korea_investment.ki_env import KoreaInvestEnv

if __name__ == '__main__':
    # 기존 main 실행 로직을 새 구조에 맞게 수정
    pass
```

### Step 8: 빈 파일들 생성 (향후 확장용)

#### `brokers/ls_securities/ls_api.py`
```python
# TODO: LS증권 API 구현 예정
# BrokerInterface를 상속받아 구현

from core.interfaces.broker_interface import BrokerInterface

class LSSecuritiesAPI(BrokerInterface):
    pass  # 향후 구현 예정
```

#### `services/account_service.py`
```python
# TODO: 계좌 관련 비즈니스 로직 서비스
# - 계좌 조회 로직
# - 잔고 관리
# - 수익률 계산

class AccountService:
    pass  # 향후 구현 예정
```

#### `ui/web/api_client.py`
```python
# TODO: 웹 클라이언트용 API 호출 클래스
# Next.js에서 사용할 API 클라이언트

class WebAPIClient:
    pass  # 향후 구현 예정
```

### Step 9: 유틸리티 파일 생성

#### `utils/logger.py`
```python
# 로깅 설정 통합 관리
from loguru import logger
import sys

def setup_logger():
    logger.remove()
    logger.add(sys.stdout, level="INFO")
    logger.add("data/logs/app.log", rotation="1 day", level="DEBUG")
```

#### `utils/helpers.py`
```python
# 공통 헬퍼 함수들
def format_currency(amount):
    return f"{amount:,}원"

def calculate_profit_rate(current_price, avg_price):
    if avg_price and avg_price != 0:
        return round((current_price - avg_price) / avg_price * 100, 2)
    return 0.0
```

### Step 10: Import 수정 및 테스트
- 각 파일의 import 구문 수정
- 기본 기능 동작 테스트
- 오류 수정 및 디버깅

## 🎯 완료 후 상태

### 동작하는 파일들
- `main.py`: 기존과 동일한 PyQt5 애플리케이션 실행
- `core/`: RSI/MACD 트레이딩 로직 포함
- `brokers/korea_investment/`: 한국투자증권 API 완전 동작
- `ui/qt/`: PyQt5 UI 완전 동작

### 준비된 빈 파일들  
- `brokers/ls_securities/`: LS증권 연동 준비
- `ui/web/`, `ui/mobile/`: 웹/모바일 클라이언트 준비
- `services/`: 서비스 계층 준비
- `tests/`: 테스트 코드 준비

## ✅ 성공 기준
1. 기존 PyQt5 애플리케이션이 새 구조에서 정상 동작
2. 모든 트레이딩 기능 (매수/매도/계좌조회) 정상 작동
3. 코드가 역할별로 명확히 분리됨
4. 향후 확장을 위한 인터페이스와 빈 파일 구조 완성

## 📅 작성일
2025-09-08

## 🔄 실행 상태
- [ ] Step 1: 폴더 구조 생성
- [ ] Step 2: 기존 파일 백업
- [ ] Step 3: 인터페이스 파일 생성
- [ ] Step 4: 핵심 로직 파일 분리
- [ ] Step 5: API 클래스 분리
- [ ] Step 6: UI 클래스 분리
- [ ] Step 7: 새로운 main.py 생성
- [ ] Step 8: 빈 파일들 생성
- [ ] Step 9: 유틸리티 파일 생성
- [ ] Step 10: Import 수정 및 테스트