# Next.js ë³€í™˜ API ì„¤ê³„ ë° êµ¬í˜„ ê³„íš

## ğŸ“‹ í˜„ì¬ ìƒí™© ë¶„ì„

### **ê¸°ì¡´ PyQt5 êµ¬ì¡°**
- **ì‹¤ì‹œê°„ ë°ì´í„°**: 4ê°œ íƒ€ì´ë¨¸ ê¸°ë°˜ í´ë§ (ê³„ì¢Œì¡°íšŒ 2ì´ˆ, TRê²°ê³¼ 0.05ì´ˆ ë“±)
- **ë°ì´í„° êµ¬ì¡°**: pandas DataFrame (realtime_watchlist_df, account_info_df)
- **ì£¼ìš” ê¸°ëŠ¥**: RSI/MACD ë§¤ë§¤ ì‹œê·¸ë„, ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸, ê³„ì¢Œ ì •ë³´ í‘œì‹œ

### **Next.js ì›¹ì•± í˜„í™©**
- **ê¸°ìˆ ìŠ¤íƒ**: Next.js 15.5.2, TypeScript, shadcn/ui, Tailwind CSS
- **í˜„ì¬ìƒíƒœ**: ì •ì  UI êµ¬í˜„ ì™„ë£Œ (ë§¤ìˆ˜/ë§¤ë„ ì¡°ê±´ ì„¤ì •, ê³„ì¢Œ ì •ë³´, ì›Œì¹˜ë¦¬ìŠ¤íŠ¸)
- **í•„ìš”ì‚¬í•­**: ë°±ì—”ë“œ API ì—°ë™, ì‹¤ì‹œê°„ ë°ì´í„° í†µì‹ 

## ğŸ—ï¸ API ì•„í‚¤í…ì²˜ ì„¤ê³„

### **1. REST API ì—”ë“œí¬ì¸íŠ¸**

#### **ğŸ“Š ê³„ì¢Œ ê´€ë¦¬ API**
```typescript
// GET /api/account/balance - ê³„ì¢Œ ì”ê³  ì¡°íšŒ
interface AccountBalance {
  total_value: number;
  holdings: Array<{
    stock_code: string;
    stock_name: string;
    quantity: number;
    avg_price: number;
    current_price: number;
    profit_rate: number;
    unrealized_pnl: number;
  }>;
}

// GET /api/account/summary - ê³„ì¢Œ ìš”ì•½
interface AccountSummary {
  account_number: string;
  total_asset: number;
  available_cash: number;
  total_profit_loss: number;
  daily_pnl: number;
}
```

#### **ğŸ“ˆ ë§¤ë§¤ ì¡°ê±´ API**
```typescript
// GET/POST /api/trading/conditions - ë§¤ìˆ˜/ë§¤ë„ ì¡°ê±´ ì„¤ì •
interface TradingConditions {
  buy_conditions: {
    amount: number;
    macd_type: "ìƒí–¥ëŒíŒŒ" | "í•˜í–¥ëŒíŒŒ" | "ì´ìƒ" | "ì´í•˜";
    rsi_value: number;
    rsi_type: "ìƒí–¥ëŒíŒŒ" | "í•˜í–¥ëŒíŒŒ" | "ì´ìƒ" | "ì´í•˜";
  };
  sell_conditions: {
    macd_type: "ìƒí–¥ëŒíŒŒ" | "í•˜í–¥ëŒíŒŒ" | "ì´ìƒ" | "ì´í•˜";
    rsi_value: number;
    rsi_type: "ìƒí–¥ëŒíŒŒ" | "í•˜í–¥ëŒíŒŒ" | "ì´ìƒ" | "ì´í•˜";
  };
}

// POST /api/trading/start - ìë™ë§¤ë§¤ ì‹œì‘
// POST /api/trading/stop - ìë™ë§¤ë§¤ ì¤‘ì§€
// GET /api/trading/status - ë§¤ë§¤ ìƒíƒœ ì¡°íšŒ
```

#### **ğŸ” ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ API**
```typescript
// GET /api/watchlist - ì‹¤ì‹œê°„ ì›Œì¹˜ë¦¬ìŠ¤íŠ¸
interface WatchlistItem {
  stock_code: string;
  current_price: number;
  profit_rate: number;
  avg_price: number;
  quantity: number;
  macd: number;
  macd_signal: number;
  rsi: number;
  trailing_stop_activated: boolean;
  trailing_stop_high: number;
}

// POST /api/watchlist/add - ì¢…ëª© ì¶”ê°€
// DELETE /api/watchlist/{stock_code} - ì¢…ëª© ì œê±°
```

#### **ğŸ“Š ì£¼ë¬¸ ê´€ë¦¬ API**
```typescript
// POST /api/orders/buy - ë§¤ìˆ˜ ì£¼ë¬¸
// POST /api/orders/sell - ë§¤ë„ ì£¼ë¬¸
interface OrderRequest {
  stock_code: string;
  quantity: number;
  price: number;
  order_type: "00" | "01"; // ì§€ì •ê°€/ì‹œì¥ê°€
}

// GET /api/orders/history - ì£¼ë¬¸ ë‚´ì—­
// GET /api/orders/pending - ë¯¸ì²´ê²° ì£¼ë¬¸
```

### **2. WebSocket ì‹¤ì‹œê°„ í†µì‹ **

#### **ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¼**
```typescript
// WebSocket ì—°ê²°: ws://localhost:8000/ws
interface RealtimeMessage {
  type: "price_update" | "watchlist_update" | "account_update" | "order_update";
  timestamp: string;
  data: any;
}

// ê°€ê²© ì—…ë°ì´íŠ¸
interface PriceUpdate {
  type: "price_update";
  data: {
    stock_code: string;
    current_price: number;
    change: number;
    change_rate: number;
  };
}

// ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ 
interface WatchlistUpdate {
  type: "watchlist_update";
  data: WatchlistItem[];
}
```

## ğŸ”§ ë°±ì—”ë“œ êµ¬í˜„ ê³„íš

### **1. FastAPI ë°±ì—”ë“œ ì„œë²„**
```python
# main.py - FastAPI ì„œë²„
from fastapi import FastAPI, WebSocket
from fastapi.middleware.cors import CORSMiddleware
import asyncio
from typing import List
import json

app = FastAPI()

# CORS ì„¤ì • (Next.js ê°œë°œì„œë²„ìš©)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ê¸°ì¡´ KoreaInvestAPI ë˜í¼
korea_invest_api = None  # ì „ì—­ ì¸ìŠ¤í„´ìŠ¤

# WebSocket ì—°ê²° ê´€ë¦¬
class ConnectionManager:
    def __init__(self):
        self.active_connections: List[WebSocket] = []
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
    
    async def disconnect(self, websocket: WebSocket):
        self.active_connections.remove(websocket)
    
    async def broadcast(self, message: dict):
        for connection in self.active_connections:
            await connection.send_text(json.dumps(message))

manager = ConnectionManager()
```

### **2. ë°ì´í„° ë™ê¸°í™” ì„œë¹„ìŠ¤**
```python
# services/realtime_service.py
import asyncio
import pandas as pd
from datetime import datetime

class RealtimeDataService:
    def __init__(self, korea_invest_api, connection_manager):
        self.api = korea_invest_api
        self.manager = connection_manager
        self.watchlist_df = pd.DataFrame()
        self.is_running = False
    
    async def start_realtime_updates(self):
        """ê¸°ì¡´ íƒ€ì´ë¨¸ ë¡œì§ì„ async/awaitë¡œ ë³€í™˜"""
        self.is_running = True
        
        # ë³‘ë ¬ ì‹¤í–‰: ê³„ì¢Œì¡°íšŒ(2ì´ˆ), TRê²°ê³¼(0.05ì´ˆ), ë“±ë½ë¥ ì¡°íšŒ(2ì´ˆ)
        await asyncio.gather(
            self._account_update_loop(),    # 2ì´ˆ ì£¼ê¸°
            self._tr_result_loop(),         # 0.05ì´ˆ ì£¼ê¸°  
            self._market_data_loop(),       # 2ì´ˆ ì£¼ê¸°
            self._settings_save_loop()      # 10ì´ˆ ì£¼ê¸°
        )
    
    async def _account_update_loop(self):
        while self.is_running:
            try:
                # ê¸°ì¡´ update_account_info() ë¡œì§
                account_data = self.api.get_acct_balance()
                await self.manager.broadcast({
                    "type": "account_update",
                    "data": account_data,
                    "timestamp": datetime.now().isoformat()
                })
            except Exception as e:
                logger.error(f"ê³„ì¢Œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: {e}")
            
            await asyncio.sleep(2)
```

## ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ ê³„íš

### **1. API í´ë¼ì´ì–¸íŠ¸ (Next.js)**
```typescript
// lib/api-client.ts
export class TradingAPIClient {
  private baseURL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
  private ws: WebSocket | null = null;
  
  // REST API í˜¸ì¶œ
  async getAccountBalance(): Promise<AccountBalance> {
    const response = await fetch(`${this.baseURL}/api/account/balance`);
    return response.json();
  }
  
  async getTradingConditions(): Promise<TradingConditions> {
    const response = await fetch(`${this.baseURL}/api/trading/conditions`);
    return response.json();
  }
  
  async updateTradingConditions(conditions: TradingConditions): Promise<void> {
    await fetch(`${this.baseURL}/api/trading/conditions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(conditions)
    });
  }
  
  // WebSocket ì—°ê²°
  connectWebSocket(onMessage: (data: RealtimeMessage) => void): void {
    this.ws = new WebSocket(`ws://localhost:8000/ws`);
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      onMessage(data);
    };
  }
}
```

### **2. React Hook ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬**
```typescript
// hooks/use-trading-data.ts
export function useTradingData() {
  const [accountBalance, setAccountBalance] = useState<AccountBalance | null>(null);
  const [watchlist, setWatchlist] = useState<WatchlistItem[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    const client = new TradingAPIClient();
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    client.getAccountBalance().then(setAccountBalance);
    client.getWatchlist().then(setWatchlist);
    
    // ì‹¤ì‹œê°„ ì—°ê²°
    client.connectWebSocket((message) => {
      switch (message.type) {
        case 'account_update':
          setAccountBalance(message.data);
          break;
        case 'watchlist_update':
          setWatchlist(message.data);
          break;
      }
    });
    
    setIsConnected(true);
  }, []);
  
  return { accountBalance, watchlist, isConnected };
}
```

## ğŸ” ë³´ì•ˆ ë° ì¸ì¦

### **1. API ì¸ì¦**
- **JWT í† í°**: ê¸°ì¡´ í•œêµ­íˆ¬ìì¦ê¶Œ í† í°ì„ JWTë¡œ ë˜í•‘
- **CORS ì„¤ì •**: Next.js ê°œë°œ/í”„ë¡œë•ì…˜ ë„ë©”ì¸ë§Œ í—ˆìš©
- **Rate Limiting**: API í˜¸ì¶œ íšŸìˆ˜ ì œí•œ

### **2. í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**
```bash
# .env.local (Next.js)
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws

# .env (FastAPI)
KI_API_KEY=***
KI_SECRET_KEY=***
KI_ACCOUNT_NUMBER=***
CORS_ORIGINS=["http://localhost:3000", "https://yourdomain.com"]
```

## ğŸ“ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### **Phase 1: ë°±ì—”ë“œ API êµ¬ì¶• (1ì£¼)**
1. FastAPI ì„œë²„ ì„¤ì • ë° ê¸°ë³¸ REST API êµ¬í˜„
2. ê¸°ì¡´ KoreaInvestAPI ë˜í¼ í´ë˜ìŠ¤ í†µí•©
3. WebSocket ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ êµ¬í˜„

### **Phase 2: í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ (1ì£¼)**  
1. Next.js API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
2. React Hook ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬ ì¶”ê°€
3. ê¸°ì¡´ ì •ì  UIë¥¼ ë™ì  ë°ì´í„°ì™€ ì—°ê²°

### **Phase 3: ê³ ë„í™” (1ì£¼)**
1. ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì—°ê²° ë¡œì§
2. ì„±ëŠ¥ ìµœì í™” (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰, ì‘ë‹µ ì†ë„)
3. ë°°í¬ í™˜ê²½ ì„¤ì • (Docker, nginx)

### **Phase 4: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (1ì£¼)**
1. ê¸°ì¡´ PyQt5 ë²„ì „ê³¼ ê¸°ëŠ¥/ì„±ëŠ¥ ë¹„êµ
2. ëª¨ì˜ ë§¤ë§¤ í™˜ê²½ì—ì„œ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸
3. ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ UX ê°œì„ 

## âš¡ ì˜ˆìƒ ì´ì 

1. **ì ‘ê·¼ì„±**: ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì–´ë””ì„œë‚˜ ì ‘ê·¼ ê°€ëŠ¥
2. **í™•ì¥ì„±**: ëª¨ë°”ì¼ ì•±, ë‹¤ì¤‘ ì‚¬ìš©ì ì§€ì› ìš©ì´
3. **ìœ ì§€ë³´ìˆ˜**: ëª¨ë˜ ì›¹ ê¸°ìˆ  ìŠ¤íƒìœ¼ë¡œ ê°œë°œ ìƒì‚°ì„± í–¥ìƒ
4. **ëª¨ë‹ˆí„°ë§**: ì›¹ ê¸°ë°˜ ëŒ€ì‹œë³´ë“œë¡œ ì§ê´€ì ì¸ ë°ì´í„° ì‹œê°í™”

## ğŸš€ êµ¬ì²´ì  êµ¬í˜„ ë‹¨ê³„

### **Step 1: ë””ë ‰í† ë¦¬ êµ¬ì¡° ì„¤ì •**
```
backend/                 # FastAPI ë°±ì—”ë“œ
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py          # FastAPI ì•± ì§„ì…ì 
â”‚   â”œâ”€â”€ api/             # REST API ë¼ìš°í„°
â”‚   â”‚   â”œâ”€â”€ account.py
â”‚   â”‚   â”œâ”€â”€ trading.py
â”‚   â”‚   â””â”€â”€ watchlist.py
â”‚   â”œâ”€â”€ models/          # Pydantic ëª¨ë¸
â”‚   â”œâ”€â”€ services/        # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â””â”€â”€ websocket/       # WebSocket í•¸ë“¤ëŸ¬
â”œâ”€â”€ requirements.txt
â””â”€â”€ Dockerfile

stock-trading-ui/        # Next.js í”„ë¡ íŠ¸ì—”ë“œ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/             # App Router
â”‚   â”œâ”€â”€ components/      # React ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ lib/             # ìœ í‹¸ë¦¬í‹°
â”‚   â”‚   â”œâ”€â”€ api-client.ts
â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â””â”€â”€ hooks/           # Custom Hooks
â”œâ”€â”€ package.json
â””â”€â”€ Dockerfile
```

### **Step 2: ë°ì´í„° ëª¨ë¸ ì •ì˜**
```typescript
// lib/types.ts - ê³µí†µ íƒ€ì… ì •ì˜
export interface StockData {
  code: string;
  name: string;
  current_price: number;
  change: number;
  change_rate: number;
  volume: number;
}

export interface TechnicalIndicators {
  rsi: number;
  macd: number;
  macd_signal: number;
  macd_histogram: number;
}

export interface Position {
  stock_code: string;
  stock_name: string;
  quantity: number;
  avg_price: number;
  current_price: number;
  unrealized_pnl: number;
  profit_rate: number;
}
```

### **Step 3: API ë¼ìš°í„° êµ¬í˜„**
```python
# app/api/account.py
from fastapi import APIRouter, Depends
from ..services.account_service import AccountService

router = APIRouter(prefix="/api/account")

@router.get("/balance")
async def get_account_balance(
    account_service: AccountService = Depends()
):
    return await account_service.get_balance()

@router.get("/positions")  
async def get_positions(
    account_service: AccountService = Depends()
):
    return await account_service.get_positions()
```

### **Step 4: WebSocket ì—°ê²° ê´€ë¦¬**
```python
# app/websocket/connection.py
from fastapi import WebSocket, WebSocketDisconnect
import asyncio
import json
from typing import List

class ConnectionManager:
    def __init__(self):
        self.active_connections: List[WebSocket] = []
        self.realtime_task = None
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
        
        # ì²« ë²ˆì§¸ ì—°ê²° ì‹œ ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ì‹œì‘
        if len(self.active_connections) == 1:
            self.realtime_task = asyncio.create_task(
                self.start_realtime_stream()
            )
    
    async def disconnect(self, websocket: WebSocket):
        self.active_connections.remove(websocket)
        
        # ë§ˆì§€ë§‰ ì—°ê²° í•´ì œ ì‹œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
        if len(self.active_connections) == 0 and self.realtime_task:
            self.realtime_task.cancel()
    
    async def broadcast(self, data: dict):
        if self.active_connections:
            message = json.dumps(data)
            disconnected = []
            
            for connection in self.active_connections:
                try:
                    await connection.send_text(message)
                except:
                    disconnected.append(connection)
            
            # ëŠì–´ì§„ ì—°ê²° ì •ë¦¬
            for conn in disconnected:
                await self.disconnect(conn)
```

### **Step 5: React Hook ìƒíƒœ ê´€ë¦¬**
```typescript
// hooks/use-realtime-data.ts
import { useState, useEffect, useCallback } from 'react';
import { TradingAPIClient } from '@/lib/api-client';

export function useRealtimeData() {
  const [accountBalance, setAccountBalance] = useState(null);
  const [watchlist, setWatchlist] = useState([]);
  const [connectionStatus, setConnectionStatus] = useState('disconnected');
  
  const client = new TradingAPIClient();
  
  const handleRealtimeMessage = useCallback((message) => {
    switch (message.type) {
      case 'account_update':
        setAccountBalance(message.data);
        break;
      case 'watchlist_update':
        setWatchlist(message.data);
        break;
      case 'connection_status':
        setConnectionStatus(message.status);
        break;
    }
  }, []);
  
  useEffect(() => {
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    Promise.all([
      client.getAccountBalance(),
      client.getWatchlist()
    ]).then(([balance, watchlistData]) => {
      setAccountBalance(balance);
      setWatchlist(watchlistData);
    });
    
    // WebSocket ì—°ê²°
    client.connectWebSocket(handleRealtimeMessage);
    
    return () => {
      client.disconnect();
    };
  }, [handleRealtimeMessage]);
  
  return {
    accountBalance,
    watchlist,
    connectionStatus,
    refreshData: () => {
      client.getAccountBalance().then(setAccountBalance);
      client.getWatchlist().then(setWatchlist);
    }
  };
}
```

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### **1. ë°±ì—”ë“œ ìµœì í™”**
- **ë¹„ë™ê¸° ì²˜ë¦¬**: asyncio ê¸°ë°˜ ë…¼ë¸”ë¡œí‚¹ I/O
- **ì»¤ë„¥ì…˜ í’€ë§**: í•œêµ­íˆ¬ìì¦ê¶Œ API ì—°ê²° ì¬ì‚¬ìš©
- **ìºì‹±**: Redisë¥¼ ì´ìš©í•œ ë¹ˆë²ˆí•œ ë°ì´í„° ìºì‹±
- **ë°°ì¹˜ ì²˜ë¦¬**: ì—¬ëŸ¬ ì¢…ëª© ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬

### **2. í”„ë¡ íŠ¸ì—”ë“œ ìµœì í™”**
- **React.memo**: ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
- **useMemo/useCallback**: ë³µì¡í•œ ê³„ì‚° ë©”ëª¨ì´ì œì´ì…˜
- **Virtual Scrolling**: ëŒ€ëŸ‰ ë°ì´í„° í…Œì´ë¸” ì„±ëŠ¥ í–¥ìƒ
- **Debouncing**: ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ìµœì í™”

### **3. ë„¤íŠ¸ì›Œí¬ ìµœì í™”**
- **WebSocket ì¬ì—°ê²°**: ìë™ ì¬ì—°ê²° ë¡œì§
- **ë°ì´í„° ì••ì¶•**: JSON ë°ì´í„° ì••ì¶• ì „ì†¡
- **Delta Updates**: ë³€ê²½ëœ ë°ì´í„°ë§Œ ì „ì†¡
- **Heartbeat**: ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§