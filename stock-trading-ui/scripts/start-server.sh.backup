#!/bin/bash

# ==========================================
# Next.js Frontend 서버 시작 스크립트
# ==========================================
# 사용법:
#   ./scripts/start-server.sh        (scripts 폴더에서)
#   ./stock-trading-ui/scripts/start-server.sh  (프로젝트 루트에서)
# ==========================================

set -e  # 에러 발생 시 스크립트 중단

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 기본 설정
DEFAULT_PORT=3000
FRONTEND_NAME="Next.js Frontend"

# 로그 함수들
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 스크립트 실행 위치 감지 및 프론트엔드 디렉토리로 이동
find_frontend_dir() {
    local current_dir=$(pwd)

    # Case 1: scripts 폴더에서 실행
    if [[ "$current_dir" == *"/stock-trading-ui/scripts" ]]; then
        cd ..
        log_info "scripts 폴더에서 실행됨 - 상위 디렉토리로 이동"

    # Case 2: stock-trading-ui 폴더에서 실행
    elif [[ "$current_dir" == *"/stock-trading-ui" ]]; then
        log_info "stock-trading-ui 폴더에서 실행됨"

    # Case 3: 프로젝트 루트에서 실행
    elif [[ -d "stock-trading-ui" ]]; then
        cd stock-trading-ui
        log_info "프로젝트 루트에서 실행됨 - stock-trading-ui로 이동"

    # Case 4: 기타 위치
    else
        log_error "stock-trading-ui 디렉토리를 찾을 수 없습니다."
        log_error "다음 위치에서 실행해주세요:"
        log_error "  1. 프로젝트 루트 디렉토리"
        log_error "  2. stock-trading-ui 디렉토리"
        log_error "  3. stock-trading-ui/scripts 디렉토리"
        exit 1
    fi

    # package.json 존재 확인
    if [[ ! -f "package.json" ]]; then
        log_error "package.json을 찾을 수 없습니다. Next.js 프로젝트가 아닙니다."
        exit 1
    fi

    log_success "Frontend 디렉토리 확인: $(pwd)"
}

# 포트 사용 여부 확인
check_port() {
    local port=$1
    if command -v lsof >/dev/null 2>&1; then
        return $(lsof -i :$port >/dev/null 2>&1; echo $?)
    elif command -v netstat >/dev/null 2>&1; then
        return $(netstat -tuln | grep ":$port " >/dev/null 2>&1; echo $?)
    elif command -v ss >/dev/null 2>&1; then
        return $(ss -tuln | grep ":$port " >/dev/null 2>&1; echo $?)
    else
        log_warning "포트 확인 도구(lsof, netstat, ss)를 찾을 수 없습니다."
        return 1
    fi
}

# 포트에서 실행 중인 프로세스 종료
kill_port_process() {
    local port=$1
    log_warning "포트 $port에서 실행 중인 프로세스를 종료합니다..."

    if command -v lsof >/dev/null 2>&1; then
        # lsof 사용
        local pids=$(lsof -ti :$port)
        if [[ -n "$pids" ]]; then
            echo $pids | xargs kill -9
            log_success "포트 $port의 프로세스들을 종료했습니다."
        fi
    elif command -v netstat >/dev/null 2>&1 && command -v awk >/dev/null 2>&1; then
        # netstat + awk 사용 (Linux)
        local pids=$(netstat -tulnp | grep ":$port " | awk '{print $7}' | cut -d'/' -f1 | grep -v '-')
        if [[ -n "$pids" ]]; then
            echo $pids | xargs kill -9
            log_success "포트 $port의 프로세스들을 종료했습니다."
        fi
    else
        log_error "포트 $port에서 실행 중인 프로세스를 자동으로 종료할 수 없습니다."
        log_error "수동으로 종료 후 다시 시도해주세요."
        exit 1
    fi

    # 잠시 대기 (프로세스 종료 완료 대기)
    sleep 2
}

# Node.js 및 npm 설치 확인
check_dependencies() {
    log_info "의존성 확인 중..."

    # Node.js 확인
    if ! command -v node >/dev/null 2>&1; then
        log_error "Node.js가 설치되지 않았습니다."
        log_error "Node.js를 설치한 후 다시 시도해주세요: https://nodejs.org/"
        exit 1
    fi

    # npm 확인
    if ! command -v npm >/dev/null 2>&1; then
        log_error "npm이 설치되지 않았습니다."
        log_error "npm을 설치한 후 다시 시도해주세요."
        exit 1
    fi

    local node_version=$(node --version)
    local npm_version=$(npm --version)

    log_success "Node.js: $node_version"
    log_success "npm: $npm_version"
}

# npm 의존성 설치
install_dependencies() {
    log_info "npm 의존성 확인 중..."

    if [[ ! -d "node_modules" ]] || [[ ! -f "node_modules/.package-lock.json" ]]; then
        log_warning "node_modules가 없거나 오래되었습니다. npm install을 실행합니다..."
        npm install
        log_success "의존성 설치 완료"
    else
        log_success "의존성이 이미 설치되어 있습니다."
    fi
}

# 개발 서버 시작
start_server() {
    local port=${1:-$DEFAULT_PORT}

    log_info "$FRONTEND_NAME 서버를 포트 $port에서 시작합니다..."

    # 포트 충돌 확인 및 처리
    if check_port $port; then
        log_warning "포트 $port가 이미 사용 중입니다."
        read -p "기존 프로세스를 종료하고 새로 시작하시겠습니까? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            kill_port_process $port
        else
            log_error "포트 $port가 사용 중이므로 서버를 시작할 수 없습니다."
            exit 1
        fi
    fi

    # 환경 변수 설정
    export PORT=$port

    log_info "서버 시작 중..."
    log_info "브라우저에서 http://localhost:$port 에 접속하세요"

    # Next.js 개발 서버 시작
    npm run dev
}

# 메인 실행 함수
main() {
    echo "=========================================="
    echo "  $FRONTEND_NAME 서버 시작 스크립트"
    echo "=========================================="

    # 1. 프론트엔드 디렉토리 찾기 및 이동
    find_frontend_dir

    # 2. 의존성 확인
    check_dependencies

    # 3. npm 의존성 설치
    install_dependencies

    # 4. 서버 시작 (포트 인자 처리)
    local target_port=${1:-$DEFAULT_PORT}
    start_server $target_port
}

# 도움말 출력
show_help() {
    echo "사용법: $0 [포트번호]"
    echo ""
    echo "옵션:"
    echo "  포트번호    서버가 실행될 포트 (기본값: 3000)"
    echo "  -h, --help  이 도움말을 출력"
    echo ""
    echo "예시:"
    echo "  $0          # 포트 3000에서 시작"
    echo "  $0 3001     # 포트 3001에서 시작"
    echo ""
    echo "실행 위치:"
    echo "  - 프로젝트 루트에서: ./stock-trading-ui/scripts/start-server.sh"
    echo "  - stock-trading-ui에서: ./scripts/start-server.sh"
    echo "  - scripts 폴더에서: ./start-server.sh"
}

# 인자 처리
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    "")
        main
        ;;
    *)
        if [[ "$1" =~ ^[0-9]+$ ]] && [[ "$1" -ge 1024 ]] && [[ "$1" -le 65535 ]]; then
            main "$1"
        else
            log_error "올바른 포트 번호를 입력해주세요 (1024-65535)"
            show_help
            exit 1
        fi
        ;;
esac